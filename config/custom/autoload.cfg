# Filament autoload workflow inspired by Prusa's cold-load routine
#
# When the IR sensor detects filament and the extruder is below the
# configured cold-extrude threshold, the printer opens an LCD menu so you
# can choose a material preset. Selecting a preset preheats the nozzle (and
# optionally the bed); once the temperatures are reached the printer beeps
# and waits for you to press *Load filament* to push material through the
# hotend. This avoids overriding Klipper's cold-extrusion guard while
# keeping the Prusa-style guided workflow.

[gcode_macro FS_AUTOLOAD_STATE]
# State holder for the autoload workflow
variable_stage: "idle"
variable_target_nozzle: 0.0
variable_target_bed: 0.0
variable_material: ""
gcode:
    # intentionally empty

[gcode_macro FS_AUTOLOAD_BEGIN]
description: Prepare the autoload prompt when filament is detected
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if printer.print_stats.state in ["printing", "paused"] %}
        {action_respond_info("Autoload disabled while %s" % printer.print_stats.state)}
        RETURN
    {% endif %}
    {% if autoload.stage not in ["idle", "complete"] %}
        RETURN
    {% endif %}
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="''"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE=0
    {% set min_temp = printer.configfile.config.extruder.min_extrude_temp|default(170)|float %}
    {% set is_cold = printer.extruder.temperature < min_temp %}
    {% if is_cold %}
        SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'await_selection'"
        SET_DISPLAY_TEXT MSG="Select filament"
        M117 Select filament
        M300 S880 P150
        {action_respond_info("Filament detected - select a material preset to preheat")}
        {% if 'display' in printer.configfile.config %}
            MENU GOTO __main __autoload __materials
        {% endif %}
    {% else %}
        SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'ready'"
        SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE={printer.extruder.target|default(printer.extruder.temperature, true)|float}
        SET_DISPLAY_TEXT MSG="Press Load to feed"
        M117 Press Load to feed
        M300 S880 P150
        {action_respond_info("Filament detected - nozzle already hot, press Load to feed")}
        {% if 'display' in printer.configfile.config %}
            MENU GOTO __main __autoload __load
        {% endif %}
    {% endif %}

[gcode_macro FS_AUTOLOAD_AUTO_TRIGGER]
description: Filament sensor insert handler
gcode:
    FS_AUTOLOAD_BEGIN

[gcode_macro FS_AUTOLOAD_PREHEAT]
description: Preheat to a material preset before loading filament
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage not in ["await_selection", "ready", "preheating"] %}
        {action_respond_info("Start autoload before selecting material")}
        RETURN
    {% endif %}
    {% if 'NOZZLE' not in params %}
        {action_respond_error("FS_AUTOLOAD_PREHEAT requires a NOZZLE temperature")}
        RETURN
    {% endif %}
    {% set nozzle = params.NOZZLE|float %}
    {% set bed = params.BED|default(0)|float %}
    {% set material = params.MATERIAL|default("") %}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE={nozzle}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE={bed}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="'%s'" % material
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'preheating'"
    {% set label = material if material else "Heating" %}
    SET_DISPLAY_TEXT MSG={"Autoload: " + label}
    M117 Autoload: {label}
    {action_respond_info("Autoload heating nozzle to %.0f°C%s" % (nozzle, (" and bed to %.0f°C" % bed) if bed > 0 else ""))}
    {% if bed > 0 %}
        M140 S{bed}
        M190 S{bed}
    {% endif %}
    M104 S{nozzle}
    M109 S{nozzle}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'ready'"
    {% set ready_msg = (material + " ready") if material else "Autoload ready" %}
    SET_DISPLAY_TEXT MSG={ready_msg}
    M117 {ready_msg}
    M300 S1760 P200
    {action_respond_info("%s - press Load to feed filament" % ready_msg)}
    {% if 'display' in printer.configfile.config %}
        MENU GOTO __main __autoload __load
    {% endif %}

[gcode_macro FS_AUTOLOAD_LOAD]
description: Run the load moves once the hotend is ready
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage != "ready" %}
        {action_respond_info("Preheat before loading filament")}
        RETURN
    {% endif %}
    {% if printer.extruder.can_extrude|lower != 'true' %}
        {action_respond_error("Nozzle is not hot enough to load filament")}
        RETURN
    {% endif %}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'loading'"
    {% set material = autoload.material %}
    SET_DISPLAY_TEXT MSG="Loading filament"
    M117 Loading filament
    SAVE_GCODE_STATE NAME=FS_AUTOLOAD_LOAD
    load_filament
    RESTORE_GCODE_STATE NAME=FS_AUTOLOAD_LOAD
    {% set done_msg = (material + " loaded") if material else "Filament loaded" %}
    SET_DISPLAY_TEXT MSG={done_msg}
    M117 {done_msg}
    M300 S880 P250
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'complete'"
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=30
    {action_respond_info(done_msg)}
    {% if 'display' in printer.configfile.config %}
        MENU GOTO __main
    {% endif %}

[gcode_macro FS_AUTOLOAD_CANCEL]
description: Cancel the autoload workflow and optionally cool heaters
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage == "idle" %}
        RETURN
    {% endif %}
    {% if autoload.target_nozzle > 0 %}
        M104 S0
    {% endif %}
    {% if autoload.target_bed > 0 %}
        M140 S0
    {% endif %}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'idle'"
    SET_DISPLAY_TEXT MSG="Autoload cancelled"
    M117 Autoload cancelled
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=0
    {action_respond_info("Autoload cancelled")}
    {% if 'display' in printer.configfile.config %}
        MENU GOTO __main
    {% endif %}

[gcode_macro FS_RUNOUT_TRIGGER]
description: Pause when the filament sensor reports runout
gcode:
    {% if printer.print_stats.state == "printing" %}
        {action_respond_info("Filament runout detected - pausing print")}
        PAUSE
    {% else %}
        {action_respond_info("Filament runout detected")}
    {% endif %}

[delayed_gcode fs_autoload_reset]
gcode:
    SET_DISPLAY_TEXT MSG=""
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'idle'"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="''"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE=0

[filament_switch_sensor prusa_ir_sensor]
switch_pin: ^!PD1
pause_on_runout: False
insert_gcode:
    FS_AUTOLOAD_AUTO_TRIGGER
runout_gcode:
    FS_RUNOUT_TRIGGER
