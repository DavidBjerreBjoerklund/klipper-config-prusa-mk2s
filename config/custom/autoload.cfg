# MK3S-style filament autoload workflow and filament sensor integration
#
# The logic mirrors Prusa's firmware sequence: once the IR sensor detects
# filament the extruder pulls the strand into the bondtech gears, the user
# selects a material preset, and the printer preheats before performing the
# fast + slow load move used by M701.

[gcode_macro FS_AUTOLOAD_STATE]
# State holder for the autoload workflow
variable_stage: "idle"
variable_target_nozzle: 0.0
variable_target_bed: 0.0
variable_material: ""
# Warm extruders get a full pre-load, while a cold extruder only pulls 2 mm
# (see FS_AUTOLOAD_PREPARE) to mimic the stock autoload nibble.
variable_preload_distance: 15.0
variable_preload_feed: 600.0
gcode:
    # intentionally empty

[gcode_macro FS_AUTOLOAD_BEGIN]
description: Start MK3S-style autoload workflow
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if printer.print_stats.state in ["printing", "paused"] %}
        {action_respond_info("Autoload disabled while %s" % printer.print_stats.state)}
        RETURN
    {% endif %}
    {% if autoload.stage not in ["idle", "complete"] %}
        {action_respond_info("Autoload already running")}
        RETURN
    {% endif %}
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'pending_selection'"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="''"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE=0
    SET_DISPLAY_TEXT MSG="Autoload: select filament"
    M117 Autoload: select filament
    M300 S880 P150
    {% if 'menu' in printer %}
        MENU GOTO __main __autoload __materials
    {% endif %}
    FS_AUTOLOAD_PREPARE

[gcode_macro FS_AUTOLOAD_PREPARE]
description: Pull filament into the extruder gears before preheat
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage != "pending_selection" %}
        RETURN
    {% endif %}
    {% set requested_distance = autoload.preload_distance|float %}
    {% if requested_distance <= 0 %}
        RETURN
    {% endif %}
    {% set feed = autoload.preload_feed|float %}
    {% set min_temp = printer.configfile.config.extruder.min_extrude_temp|default(170)|float %}
    {% set allow_cold = printer.extruder.temperature < min_temp %}
    {% set distance = 2.0 if allow_cold else requested_distance %}
    SAVE_GCODE_STATE NAME=FS_AUTOLOAD_PREPARE
    M83
    {% if allow_cold %}
        M302 S0
        M302 P1
    {% endif %}
    G1 E{distance} F{feed}
    {% if allow_cold %}
        M302 S{min_temp|int}
        M302 P0
    {% endif %}
    RESTORE_GCODE_STATE NAME=FS_AUTOLOAD_PREPARE
    M400

[gcode_macro FS_AUTOLOAD_AUTO_TRIGGER]
description: Filament sensor insert handler
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage not in ["idle", "complete"] %}
        RETURN
    {% endif %}
    FS_AUTOLOAD_BEGIN
    {action_respond_info("Filament detected. Choose a material in the Autoload menu.")}

[gcode_macro FS_AUTOLOAD_PREHEAT]
description: Preheat for autoload and run the Prusa-style load sequence
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage not in ["pending_selection", "preheating"] %}
        {action_respond_info("Start autoload before selecting material")}
        RETURN
    {% endif %}
    {% if 'NOZZLE' not in params %}
        {action_respond_error("FS_AUTOLOAD_PREHEAT requires a NOZZLE temperature")}
        RETURN
    {% endif %}
    {% set nozzle = params.NOZZLE|float %}
    {% set bed = params.BED|default(0)|float %}
    {% set material = params.MATERIAL|default("") %}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE={nozzle}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE={bed}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="'%s'" % material
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'preheating'"
    {% set msg = "Autoload: " + (material if material else "heating") %}
    SET_DISPLAY_TEXT MSG="{msg}"
    M117 {msg}
    {% if bed > 0 %}
        M140 S{bed}
    {% endif %}
    M104 S{nozzle}
    {% if bed > 0 %}
        M190 S{bed}
    {% endif %}
    M109 S{nozzle}
    FS_AUTOLOAD_EXEC

[gcode_macro FS_AUTOLOAD_EXEC]
description: Perform the MK3S fast+slow load once preheated
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage != "preheating" %}
        RETURN
    {% endif %}
    {% set material = autoload.material %}
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'loading'"
    SAVE_GCODE_STATE NAME=FS_AUTOLOAD_EXEC
    M83
    G1 E70 F1200
    G1 E25 F198
    M82
    RESTORE_GCODE_STATE NAME=FS_AUTOLOAD_EXEC
    M400
    {% set msg = (material + " loaded") if material else "Filament loaded" %}
    SET_DISPLAY_TEXT MSG="{msg}"
    M117 {msg}
    M300 S880 P150
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'complete'"
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=30
    {% if 'menu' in printer %}
        MENU GOTO __main
    {% endif %}

[gcode_macro FS_AUTOLOAD_CANCEL]
description: Cancel the autoload workflow and reset heaters if needed
gcode:
    {% set autoload = printer["gcode_macro FS_AUTOLOAD_STATE"] %}
    {% if autoload.stage == "idle" %}
        RETURN
    {% endif %}
    {% if autoload.target_nozzle > 0 %}
        M104 S0
    {% endif %}
    {% if autoload.target_bed > 0 %}
        M140 S0
    {% endif %}
    SET_DISPLAY_TEXT MSG="Autoload cancelled"
    M117 Autoload cancelled
    UPDATE_DELAYED_GCODE ID=fs_autoload_reset DURATION=0
    {% if 'menu' in printer %}
        MENU GOTO __main
    {% endif %}

[gcode_macro FS_RUNOUT_TRIGGER]
description: Pause when the filament sensor reports runout
gcode:
    {% if printer.print_stats.state == "printing" %}
        {action_respond_info("Filament runout detected - pausing print")}
        PAUSE
    {% else %}
        {action_respond_info("Filament runout detected")}
    {% endif %}

[delayed_gcode fs_autoload_reset]
gcode:
    SET_DISPLAY_TEXT MSG=""
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=stage VALUE="'idle'"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=material VALUE="''"
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_nozzle VALUE=0
    SET_GCODE_VARIABLE MACRO=FS_AUTOLOAD_STATE VARIABLE=target_bed VALUE=0

[filament_switch_sensor prusa_ir_sensor]
switch_pin: ^!PD1
pause_on_runout: False
insert_gcode:
    FS_AUTOLOAD_AUTO_TRIGGER
runout_gcode:
    FS_RUNOUT_TRIGGER
